name: Deploy to EC2 (v2)

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

env:
  EC2_HOST: 13.211.169.169
  EC2_USER: ubuntu
  DEPLOY_PATH: ~/smart-yoram-backend

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      env:
        DATABASE_URL: sqlite:///./test.db
        SECRET_KEY: test-secret-key-for-ci
      run: |
        # Run pytest if tests exist
        if [ -d "tests" ]; then
          pytest tests/ -v
        else
          echo "No tests directory found, skipping tests"
        fi
    
    - name: Check code formatting
      run: |
        # Temporarily skip black formatting check
        echo "Skipping black format check for debugging"

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: test
    environment: production
    # Only deploy on push to main or manual trigger, not on PRs
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Validate secrets
      run: |
        echo "Validating required secrets..."
        if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
          echo "âŒ EC2_SSH_KEY secret is not set!"
          exit 1
        fi
        echo "âœ… All required secrets are configured"

    - name: Prepare deployment directory
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.EC2_HOST }}
        username: ${{ env.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸ”§ Preparing deployment directory..."
          # Create directory if it doesn't exist
          mkdir -p ~/smart-yoram-backend
          
          # Fix directory permissions
          sudo chown -R ubuntu:ubuntu ~/smart-yoram-backend || true
          chmod -R 755 ~/smart-yoram-backend || true
          
          echo "âœ… Directory prepared"

    - name: Copy files to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.EC2_HOST }}
        username: ${{ env.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        source: "."
        target: ${{ env.DEPLOY_PATH }}
        rm: false
        overwrite: true
        strip_components: 0
        timeout: 60s
        command_timeout: 15m

    - name: Upload .env to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.EC2_HOST }}
        username: ${{ env.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd ~/smart-yoram-backend
          
          # Check if ENV_FILE secret exists
          if [ ! -z "${{ secrets.ENV_FILE }}" ]; then
            echo "Creating .env file from GitHub Secrets..."
            # Create .env file using printf to preserve formatting
            printf '%s\n' "${{ secrets.ENV_FILE }}" > .env
            chmod 600 .env
            echo "âœ… .env file created from secrets"
          elif [ -f .env.template ]; then
            echo "âš ï¸ ENV_FILE secret not found, using template..."
            cp .env.template .env
            chmod 600 .env
            echo "âš ï¸ Using template .env - please update values!"
          else
            echo "âŒ No ENV_FILE secret and no template found"
          fi

    - name: Deploy application
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.EC2_HOST }}
        username: ${{ env.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 30m
        script: |
          set -e  # Exit on any error
          
          echo "ğŸš€ Starting deployment process..."
          cd ~/smart-yoram-backend
          
          # í•„ìˆ˜ íŒŒì¼ í™•ì¸
          if [ ! -f .env ]; then
            echo "âŒ ERROR: .env file not found!"
            echo "Please set ENV_FILE in GitHub Secrets or create .env file on the server."
            
            # Try to use .env.example as template
            if [ -f .env.example ]; then
              echo "Creating .env from .env.example template..."
              cp .env.example .env
              chmod 600 .env
              echo "âš ï¸  Using template .env file - please update with actual values"
            else
              exit 1
            fi
          fi
          echo "âœ… Environment file found"
          
          # Dockerë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°
          if [ -f docker-compose.yml ]; then
            echo "âœ… Docker Compose file found"
            
            # í¬íŠ¸ 8000 í™•ì¸ ë° ì •ë¦¬
            echo "ğŸ” Checking for processes using port 8000..."
            
            # ëª¨ë“  ê´€ë ¨ Docker ì»¨í…Œì´ë„ˆ ì¤‘ì§€
            echo "Stopping existing containers..."
            sudo docker-compose down --remove-orphans || true
            
            # í¬íŠ¸ 8000ì„ ì‚¬ìš©í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            if sudo lsof -i :8000; then
              echo "ğŸ›‘ Port 8000 is in use. Force killing processes..."
              sudo lsof -ti:8000 | xargs -r sudo kill -9 || true
              sleep 5
            fi
            
            # ìµœì¢… í™•ì¸
            if sudo lsof -i :8000; then
              echo "âŒ ERROR: Port 8000 is still in use after cleanup!"
              sudo lsof -i :8000
              exit 1
            else
              echo "âœ… Port 8000 is now available"
            fi
            
            # Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬
            echo "ğŸ§¹ Cleaning up Docker resources..."
            sudo docker system prune -f || true
            
            # ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹œì‘
            echo "ğŸ—ï¸  Building and starting containers..."
            sudo docker-compose up --build -d --force-recreate --remove-orphans
            
            # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°
            echo "â³ Waiting for containers to be ready..."
            sleep 10
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "ğŸ“Š Checking container status..."
            sudo docker-compose ps
            
            # ì›¹ ì„œë¹„ìŠ¤ í™•ì¸
            echo "ğŸ” Checking web service..."
            if sudo docker-compose ps | grep -q "backend.*Up"; then
              echo "âœ… Backend container is running"
            else
              echo "âŒ Backend container is not running"
              sudo docker-compose logs backend
              exit 1
            fi
            
            # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
            echo "ğŸ”„ Running database migrations..."
            sudo docker-compose exec -T backend alembic upgrade heads || echo "âš ï¸  Migration failed (continuing)"
            
            # ë°ëª¨ ë°ì´í„° ìƒì„± (church_id 9999ìš©)
            echo "ğŸ“Š Creating demo data for church ID 9999..."
            sudo docker-compose exec -T backend python3 deploy_demo_data.py || echo "âš ï¸  Demo data creation failed (continuing)"
            
          else
            echo "No Docker Compose found, using Python virtual environment..."
            
            # Python í™˜ê²½ ì„¤ì •
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            
            source venv/bin/activate
            
            # ì˜ì¡´ì„± ì„¤ì¹˜
            pip install --upgrade pip
            pip install -r requirements.txt
            
            # ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            pkill -f "uvicorn app.main:app" || true
            
            # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
            echo "ğŸ”„ Running database migrations..."
            alembic upgrade heads || echo "âš ï¸  Migration failed (continuing)"
            
            # ë°ëª¨ ë°ì´í„° ìƒì„± (church_id 9999ìš©)
            echo "ğŸ“Š Creating demo data for church ID 9999..."
            python3 deploy_demo_data.py || echo "âš ï¸  Demo data creation failed (continuing)"
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
            echo "ğŸš€ Starting application..."
            nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > app.log 2>&1 &
            
            sleep 5
            
            # í”„ë¡œì„¸ìŠ¤ í™•ì¸
            if ps aux | grep "uvicorn app.main:app" | grep -v grep > /dev/null; then
              echo "âœ… Application started successfully"
            else
              echo "âŒ Failed to start application"
              tail -20 app.log
              exit 1
            fi
          fi
          
          # Nginx ì„¤ì • ì—…ë°ì´íŠ¸ (íŒŒì¼ ì—…ë¡œë“œ ì§€ì›)
          echo "ğŸ”§ Updating Nginx configuration..."
          if [ -f nginx.conf ]; then
            # Nginx ì„¤ì • íŒŒì¼ ë°±ì—…
            sudo cp /etc/nginx/sites-available/default /etc/nginx/sites-available/default.backup.$(date +%Y%m%d_%H%M%S) || true
            
            # ìƒˆ ì„¤ì • ì ìš©
            sudo cp nginx.conf /etc/nginx/sites-available/smart-yoram-backend
            sudo ln -sf /etc/nginx/sites-available/smart-yoram-backend /etc/nginx/sites-enabled/smart-yoram-backend || true
            
            # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸
            if sudo nginx -t; then
              echo "âœ… Nginx configuration is valid"
              sudo systemctl reload nginx || echo "âš ï¸  Nginx reload failed (continuing)"
            else
              echo "âŒ Nginx configuration test failed"
              # ì›ë³¸ ì„¤ì •ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
              sudo rm -f /etc/nginx/sites-enabled/smart-yoram-backend || true
              sudo systemctl reload nginx || true
            fi
          else
            echo "âš ï¸  nginx.conf not found, skipping nginx configuration update"
          fi
          
          # API í—¬ìŠ¤ ì²´í¬
          echo "ğŸ§ª Testing API endpoint..."
          sleep 5
          if curl -f -s http://localhost:8000/health > /dev/null 2>&1; then
            echo "âœ… API health check passed"
          else
            echo "âš ï¸  API health check failed (will continue)"
            # ë¡œê·¸ í™•ì¸
            if [ -f docker-compose.yml ]; then
              sudo docker-compose logs --tail=20 backend
            else
              tail -20 app.log
            fi
          fi
          
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“ Application is running at: http://${{ env.EC2_HOST }}:8000"